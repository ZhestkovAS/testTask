!function(t,n,l,s){"use strict";var a,i,c,r,o,d,u,p,f,_,g,v,e,h,b,m,y,k,C={},w=l.photos=function(){return!0},P='<div class="s_block s_bo"><div class="s_block-content"></div></div>',x='<span class="s_block-header"><span class="s_but s_but-back"><svg class="s_ma-right"><g><line y2="2" x2="8" y1="8" x1="2" stroke-width="1" fill="none"></line><line y2="14" x2="8" y1="8" x1="2" fill-opacity="null" stroke-opacity="null" stroke-width="1" fill="none"></line></g></svg><a href="#" class="s_but s_but-link ub">В галерею</a></span><span class="s_te-l">Загрузить фотографии</span><span class="s_fl-right"><a href="#" class="s_but s_but-action s_ma-right">Выбрать изображения</a> <a href="#" style="display:none;" class="s_but s_but-link ub">Тест</a><input type="file" name="s_gallery_files" class="s_di-hidden" multiple ></span></span>',U='<div class="s_content"><span class="s_layout"></span><div class="s_center--images"></div></div>',E='<div class="s_info-block s_center--info"><div class="s_info-block--text s_ta-left"><span class="s_te-l s_di-inline-block s_ma-bottom">Для загрузки изображений в галерею нажмите "выбрать изображение" или перенесите их сюда</span><br><span class="s_te-m s_co-g">расширения: .jpg, .jpeg, .png</span></div></div>',L='<span class="s_url"><div class="s_di-table"><div class="s_di-table-cell s_wi-100"><span class="s_input s_wi-100"><input type="text" name="s_url-image" class="s_url-input" autocomplete="off" placeholder="http://example.com/image.jpg"><span class="s_input-remove"><svg><g xmlns="http://www.w3.org/2000/svg"><line y2="14" x2="14" y1="2" x1="2" fill="none"></line><line y2="2" x2="14" y1="14" x1="2" fill="none"></line></g></svg></span></span></div><div class="s_di-table-cell"><a href="#" class="s_but s_but-control s_ma-right upl_fu">Загрузить</a></div></div></span>',O='<span class="s_layout red"><div class="s_layout-middle s_di-table s_wi-100 s_he-100 s_ta-center"><div class="s_di-table-cell s_wi-100"><span class="s_te-l"></span></div></div>',D='<div class="s_layout-middle s_ta-center"><div class="s_dragndrop--title">Перетащите изображения сюда</div></div>',R='<div class="s_progress s_di-table s_wi-100 s_he-100 s_ta-center"><div class="s_di-table-cell"><svg width="38px" height="38px" class="s_ma-bottom s_progress-svg"><g><circle r="17" cy="19" cx="19" fill="none" stroke="#FFF" stroke-width="1"/><circle r="17" cy="19" cx="19" fill="none" stroke="#0078d1" stroke-width="1" class="s_progress_circle"/></g></svg><br><span class="">Загрузка изображений...</span></div></div>',M='<div class="s_content-image"><span class="s_content-image--b_block s_bo"><a href="#" title="Удалить изображение"><svg><g xmlns="http://www.w3.org/2000/svg"><line y2="14" x2="14" y1="2" x1="2" fill="none"></line><line y2="2" x2="14" y1="14" x1="2" fill="none"></line></g></svg></a></span><img src=""><div class="s_content-image--title s_wi-100"></div></div>';l.extend(w,{INIT:function(t){k=t,w.GENERATEBLOCK()},GENERATEBLOCK:function(){var s,e;b=l(x),a=b.find(".s_fl-right > a:nth-child(1)"),b.find(".s_but-back > a").attr("href","/gallery/"+k.attr("data-gallery")),i=b.find(".s_fl-right > a:nth-child(2)"),c=b.find("input[type=file]"),a.on("click",function(t){return t.preventDefault(),w.UPLFF()}),i.on("click",function(t){return t.preventDefault(),w.UPLFU()}),c.on("change",function(t){w.UPLOAD("ff",this.files)}),r=l(P),u=l(O),r.prepend(u),(o=r.find(".s_block-content")).append(b),d=l(U),p=d.find(".s_layout"),(v=d.find(".s_center--images")).append(l(E)),p.on("click",function(t){return t.target===this?(t.preventDefault(),w.MBCW_C()):void 0}),f=l(L),_=l(D),g=l(R),p.append(f),p.append(_),p.append(g),o.append(d),k.append(r),t.addEventListener("dragover",function(t){(t=t||event).preventDefault()},!1),t.addEventListener("drop",function(t){(t=t||event).preventDefault()},!1),l(n).on("dragenter",function(t){e=t.target,y||"upl"==m||w.UPLDD()}).on("dragleave",function(t){e===t.target&&(y||"upl"==m||w.MBCW_C())}),l(r).on("dragenter",function(t){s=t.target,y||"upl"==m||p.addClass("blue")}).on("dragleave",function(t){s===t.target&&(y||"upl"==m||p.removeClass("blue"))}).on("drop",function(t){if(!y&&"upl"!=m){w.MBCW_CF(),p.removeClass("blue");try{t.originalEvent.dataTransfer.files&&w.UPLOAD("fd",t.originalEvent.dataTransfer.files)}catch(t){w.GERROR(1,"Ошибка: не получены файлы для загрузки")}}})},UPLDD:function(){m="dd",w.MBCW_O(),_.show()},UPLFF:function(){return"upl"!=m&&void c.trigger("click")},UPLFP:function(){m="upl",w.MBCW_O(),w.UPLFP_SP(0),g.show()},UPLFP_SP:function(t){var s=g.find("svg > g > circle:nth-child(2)"),e=34*Math.PI;t<0&&(t=0),100<t&&(t=100);var n=(100-t)/100*e;s.attr({"stroke-dasharray":e,"stroke-dashoffset":e}),s.css({strokeDashoffset:n})},UPLFU:function(){var s;return"url"!=m&&"upl"!=m&&(m="url",w.MBCW_O(),f.slideDown(200),e||((e=f.find("input")).focus(),e.on("keyup",function(){w.UPLFU_INPUT(l(this))})),void(h||(h=f.find(".upl_fu")).on("click",function(t){t.preventDefault(),s=e.val(),e.val(""),e.closest("span.s_input").find("span.s_input-remove").fadeOut(200),w.UPLOAD("fu",s)})))},UPLFU_INPUT:function(t){var s=t.closest("span.s_input").find("span.s_input-remove");return s.on("click",function(){t.val(""),l(this).fadeOut(200)}),0<t.val().length?s.fadeIn(200):s.fadeOut(200),!0},MBCW_CF:function(t){f.hide(),_.hide(),g.hide()},MBCW_O:function(t){w.MBCW_CF(t),p.fadeIn(200),d.addClass("blur")},MBCW_C:function(t){w.MBCW_CF(t),p.fadeOut(200),d.removeClass("blur"),m=""},UPLOAD:function(t,s){var e,n=!1;switch(t){case"fu":s.length?w.URLTEST(s)?(n=!0,i=s):e="Ошибка: неверно указан URL адрес изображения":e="Ошибка: не указан URL адрес изображения";break;case"fd":case"ff":var a,i=[];s.length?(l.each(s,function(t,s){s.name.match(/.(jpg|jpeg|png|gif)$/i)&&s.type.match(/.(jpg|jpeg|png|gif)$/i)?i.push(t):a=a+s.name+", "}),a&&(e="Файлы ("+a+") не загружены т.к. не являются изображениями")):e="Ошибка: не получены файлы для загрузки",i.length&&(n=!0)}return n?(w.UPLFP(),w.AJAX(t,i,s)):(w.GERROR(1,e),!1)},AJAX:function(t,s,e){var n=new FormData;switch(t){case"fu":n.append("url",s);break;case"fd":case"ff":l.each(s,function(t,s){n.append("file_"+t,e[s])}),n.append("gallery",k.attr("data-gallery"))}l.ajax({url:k.attr("data-action"),type:"POST",processData:!1,contentType:!1,data:n,xhr:function(){var t=l.ajaxSettings.xhr();return t.upload.addEventListener("progress",function(t){t.lengthComputable&&w.UPLFP_SP(Math.ceil(t.loaded/t.total*100))},!1),t},success:function(t){return t=JSON.stringify(t),0<(t=JSON.parse(t)).photos.length?(w.ADDIMAGES(t.photos),!0):t.photos.error?(w.GERROR(1,t.photos.error),w.MBCW_C(),!1):void 0}})},URLTEST:function(t){return!!/(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/.test(t)},ADDIMAGES:function(t){Object.keys(C).length||v.html(""),l.each(t,function(t,s){var e=l(M),n={};n.src=s.src,n.title=s.title,C[s.id]=n,e.find("img").attr("src",n.src),e.find("img").attr("width","150"),e.find("img").attr("height","150"),e.find(".s_content-image--title").text(n.title),e.find(".s_content-image--b_block > a:nth-child(1)").on("click",function(t){t.preventDefault(),w.REMOVE_IMAGE(s.id,e)}),e.prop("s_gallery_image_id",s.id),v.append(e)}),w.MBCW_C(),b.hasClass("back")||b.addClass("back")},REMOVE_IMAGE:function(t,s){confirm("Вы действительно хотите удалить изображение?")&&(delete C[t],l.ajax({url:k.attr("data-action")+"/?what=remove",type:"POST",data:{ids:t},success:function(t){}}),s.remove(),""==v.html()&&v.append(l(E)))},GERROR:function(t,s){t?(y=1,"dd"==m&&w.MBCW_C(),u.find("span").text(s),u.fadeIn(200),r.addClass("blur"),setTimeout(function(){u.hide(),r.removeClass("blur"),y=0},5e3)):(y=0,u.hide(),r.removeClass("blur")),u.on("click",function(){w.GERROR(0,"")})}}),l.fn.photos=function(){w.INIT(l(this))}}(window,document,jQuery);